<!DOCTYPE html>

<html lang="ru" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>app.views &#8212; документация Bull Heart v0.0.1</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script src="../../_static/documentation_options.js?v=41ec4187"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=29b1f277"></script>
    <link rel="index" title="Алфавитный указатель" href="../../genindex.html" />
    <link rel="search" title="Поиск" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Исходный код app.views</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Этот модуль содержит представления(контроллеры), используемые в приложении.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">logout</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="kn">import</span> <span class="n">validate_email</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Category</span><span class="p">,</span> <span class="n">Product</span><span class="p">,</span> <span class="n">Cart</span><span class="p">,</span> <span class="n">ProductStack</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">EmailActivation</span><span class="p">,</span> <span class="n">Order</span>
<span class="kn">import</span> <span class="nn">threading</span>


<span class="n">responces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;success&quot;</span> <span class="p">:</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;200&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Success.&#39;</span><span class="p">}),</span>
    <span class="s2">&quot;error&quot;</span> <span class="p">:</span>  <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;404&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Error occured&#39;</span><span class="p">}),</span>
    <span class="s2">&quot;no_auth&quot;</span> <span class="p">:</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;403&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Not Authenticated.&#39;</span><span class="p">}),</span>
<span class="p">}</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;wrong_login_data&#39;</span><span class="p">:</span> <span class="s1">&#39;Неверные пароль или имя пользователя.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wrong_signup_data&#39;</span><span class="p">:</span> <span class="s1">&#39;Введены неверные данные.&#39;</span>
<span class="p">}</span>

<div class="viewcode-block" id="index">
<a class="viewcode-back" href="../../source/app/app.html#app.views.index">[документация]</a>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление главной страницы. </span>
<span class="sd">       Возвращает каталог с категориями по GET запросу.&quot;&quot;&quot;</span>

    <span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;categories&#39;</span><span class="p">:</span> <span class="n">categories</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">})</span></div>



<div class="viewcode-block" id="about">
<a class="viewcode-back" href="../../source/app/app.html#app.views.about">[документация]</a>
<span class="k">def</span> <span class="nf">about</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление страницы о компании. </span>
<span class="sd">       Возвращает страницу с информацией о компании по GET запросу.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;about.html&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="category">
<a class="viewcode-back" href="../../source/app/app.html#app.views.category">[документация]</a>
<span class="k">def</span> <span class="nf">category</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление страницы категории. </span>
<span class="sd">       Возвращает страницу категории с карточками с товарами по GET запросу.&quot;&quot;&quot;</span>

    <span class="n">category</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;category.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">})</span></div>



<div class="viewcode-block" id="product">
<a class="viewcode-back" href="../../source/app/app.html#app.views.product">[документация]</a>
<span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление страницы товара. </span>
<span class="sd">       Возвращает страницу товара с информацией о нем по GET запросу.&quot;&quot;&quot;</span>

    <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;product.html&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">,</span>
    <span class="p">})</span></div>



<div class="viewcode-block" id="cart">
<a class="viewcode-back" href="../../source/app/app.html#app.views.cart">[документация]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">cart</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление страницы корзины. Требует авторизации.</span>
<span class="sd">       Возвращает страницу корзины с товарами пользователя по GET запросу.&quot;&quot;&quot;</span>

    <span class="n">cart</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Cart</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">product_stacks</span> <span class="o">=</span> <span class="n">cart</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;cart.html&quot;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="s1">&#39;product_stacks&#39;</span><span class="p">:</span> <span class="n">product_stacks</span><span class="p">,</span>
            <span class="s1">&#39;cart&#39;</span> <span class="p">:</span> <span class="n">cart</span><span class="p">,</span>
    <span class="p">})</span></div>



<div class="viewcode-block" id="cart_add">
<a class="viewcode-back" href="../../source/app/app.html#app.views.cart_add">[документация]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">cart_add</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API добавления товара в корзину. Требует авторизации.</span>
<span class="sd">      По POST запросу добавляет стэк товара указанного кол-ва в корзину, если такой товар есть и</span>
<span class="sd">      возвращает JSONResponce с статусом 200.&quot;&quot;&quot;</span>

    <span class="n">product_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
    <span class="n">product_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">product_id</span><span class="p">)</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cart</span>
    <span class="n">product_stack</span> <span class="o">=</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_product_stack</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product_stack</span><span class="p">:</span>
        <span class="n">product_stack</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">product_count</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">product_stack</span> <span class="o">=</span> <span class="n">ProductStack</span><span class="p">(</span><span class="n">cart</span><span class="o">=</span><span class="n">cart</span><span class="p">,</span> <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">product_count</span><span class="p">)</span>
    <span class="n">product_stack</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">responces</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span></div>



<div class="viewcode-block" id="cart_delete">
<a class="viewcode-back" href="../../source/app/app.html#app.views.cart_delete">[документация]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">cart_delete</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API для удаления товара из корзины. Требует авторизации.</span>
<span class="sd">       По POST запросу удаляет стэк товара, если он есть в корзине и</span>
<span class="sd">       возвращает JSONResponce с статусом 200 в случае успеха и </span>
<span class="sd">       статусом 404 при ошибке&quot;&quot;&quot;</span>

    <span class="n">product_stack</span> <span class="o">=</span> <span class="n">get_product_stack_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">product_stack</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">responces</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">responces</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span></div>



<div class="viewcode-block" id="cart_change">
<a class="viewcode-back" href="../../source/app/app.html#app.views.cart_change">[документация]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">cart_change</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API для изменения количества товара в стэке в корзине. Требует авторизации.&quot;&quot;&quot;</span>

    <span class="n">product_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
    <span class="n">product_stack</span> <span class="o">=</span> <span class="n">get_product_stack_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">product_stack</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">product_count</span>
    <span class="n">product_stack</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">responces</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_product_stack_from_request">
<a class="viewcode-back" href="../../source/app/app.html#app.views.get_product_stack_from_request">[документация]</a>
<span class="k">def</span> <span class="nf">get_product_stack_from_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Вспомогательный метод для получения стэка товара</span>
<span class="sd">       из POST-запроса по id товара.&quot;&quot;&quot;</span>

    <span class="n">product_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">product_id</span><span class="p">)</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cart</span>
    <span class="n">product_stack</span> <span class="o">=</span> <span class="n">cart</span><span class="o">.</span><span class="n">get_product_stack</span><span class="p">(</span><span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">product_stack</span></div>



<div class="viewcode-block" id="login_view">
<a class="viewcode-back" href="../../source/app/app.html#app.views.login_view">[документация]</a>
<span class="k">def</span> <span class="nf">login_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление авторизации на сайте.</span>
<span class="sd">       По GET запросу возвращает страницу входа на сайт.</span>
<span class="sd">       По POST запросу в случае успешного входа перенаправляет на главную страницу,</span>
<span class="sd">       в случае неудачи возращает страницу входа с сообщением об ошибке.</span>
<span class="sd">       Если пользователь авторизован, перенаправляет на главную.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;auth/login.html&#39;</span><span class="p">)</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;auth/login.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span>  <span class="s1">&#39;Неверные пароль или имя пользователя.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;last_username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
    <span class="p">})</span></div>


<div class="viewcode-block" id="logout_view">
<a class="viewcode-back" href="../../source/app/app.html#app.views.logout_view">[документация]</a>
<span class="k">def</span> <span class="nf">logout_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление для выхода из аккаунта на сайте.</span>
<span class="sd">       По GET запросу разлогинивает пользователя и перенаправляет на страницу входа.&quot;&quot;&quot;</span>

    <span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">login_view</span><span class="p">)</span></div>


<div class="viewcode-block" id="signup_view">
<a class="viewcode-back" href="../../source/app/app.html#app.views.signup_view">[документация]</a>
<span class="k">def</span> <span class="nf">signup_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление для регистрации аккаунта на сайте.</span>
<span class="sd">       По GET запросу возвращает страницу регистрации на сайте.</span>
<span class="sd">       По POST запросу в случае успешного регистрации создает нового пользователя</span>
<span class="sd">       и отправляет на почту ссылку для подтверждения почты,</span>
<span class="sd">       в случае неудачи возращает страницу регистрации с сообщением об ошибке.</span>
<span class="sd">       Если пользователь авторизован, перенаправляет на главную.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;auth/signup.html&#39;</span><span class="p">)</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">and</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;auth/signup.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Введены неверные данные.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;last_username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                <span class="s1">&#39;last_email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_user_exist</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Customer&#39;</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cart</span> <span class="o">=</span> <span class="n">Cart</span><span class="p">()</span>
            <span class="n">cart</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">cart</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">activation</span> <span class="o">=</span> <span class="n">EmailActivation</span><span class="p">()</span>
            <span class="n">activation</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">activation</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
            <span class="n">activation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">activation</span><span class="o">.</span><span class="n">send_email</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
           
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;auth/signup.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Введены неверные данные.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;last_username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                <span class="s1">&#39;last_email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
    <span class="p">})</span></div>



<div class="viewcode-block" id="activation_view">
<a class="viewcode-back" href="../../source/app/app.html#app.views.activation_view">[документация]</a>
<span class="k">def</span> <span class="nf">activation_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление для активации почты.</span>
<span class="sd">       Если ключ действителен то подтверждает пользователя(user.is_active = True).</span>
<span class="sd">       Если ключ больше не действителен, то возвращает сообщение об ошибке.</span>
<span class="sd">       Если аккаунт уже подтвержден, то возвращает сообщение об ошибке.&quot;&quot;&quot;</span>

    <span class="n">email_activation</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">EmailActivation</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">email_activation</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">email_activation</span><span class="o">.</span><span class="n">expires_in</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Ключ подтверждения больше не действителен.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">email_activation</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">email_activation</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">email_activation</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Вы успешно подтвердили аккаунт!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Ваш аккаунт уже подтвержден.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_user_exist">
<a class="viewcode-back" href="../../source/app/app.html#app.views.is_user_exist">[документация]</a>
<span class="k">def</span> <span class="nf">is_user_exist</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Вспомогательный метод, определяющий существует ли пользователь</span>
<span class="sd">       с заданным username и(или) email в базе данных.</span>
<span class="sd">       Возвращает True - если да, False - если нет.&quot;&quot;&quot;</span>

    <span class="n">invalidName</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">invalidEmail</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">invalidName</span> <span class="ow">or</span> <span class="n">invalidEmail</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="order_creation">
<a class="viewcode-back" href="../../source/app/app.html#app.views.order_creation">[документация]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">order_creation</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление оформления заказа. Требует авторизацию.</span>
<span class="sd">       По GET запросу возвращает страницу оформления заказа.</span>
<span class="sd">       По POST запросу создает новый заказ с содержимым из корзины и </span>
<span class="sd">       уведомляет об этом пользователя по почте, возвращает сообщение</span>
<span class="sd">       о оформлении в случае успеха.&quot;&quot;&quot;</span>
       
    <span class="n">summ</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">get_summ</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;order_creation.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;products&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="s1">&#39;summ&#39;</span> <span class="p">:</span> <span class="n">summ</span><span class="p">,</span>
            <span class="p">})</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">()</span>
        <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#active status</span>
        <span class="n">order</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">order</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">cart</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">send_new_order_email</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Заказ успешно оформлен.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="order">
<a class="viewcode-back" href="../../source/app/app.html#app.views.order">[документация]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">order_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление страницы конкретного заказа. Требует авторизацию.</span>
<span class="sd">       По GET запросу возвращает страницу заказа.&quot;&quot;&quot;</span>

    <span class="n">order</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">order_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">order_id</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;403 Forbidden&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;order.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">})</span></div>



<div class="viewcode-block" id="order_list">
<a class="viewcode-back" href="../../source/app/app.html#app.views.order_list">[документация]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">order_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Представление страницы списка заказов Требует авторизацию.</span>
<span class="sd">       По GET запросу возвращает список заказов.</span>
<span class="sd">       Если пользователь имеет роль Customer, возвращает только его заказы.</span>
<span class="sd">       Если пользователь имеет роль Seller, возращает все заказы.&quot;&quot;&quot;</span>

    <span class="n">orders</span> <span class="o">=</span> <span class="n">Orders</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Bull Heart</a></h1>








<h3>Навигация</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Код модуля</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Быстрый поиск</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Искать" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Трефилов Артемий.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>